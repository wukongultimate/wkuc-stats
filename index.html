<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Wukong Ultimate Stats</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0; padding: 12px; background: #0a0a0a; color: #e8e8e8; min-height: 100vh;
        }
        .header { text-align: center; margin-bottom: 20px; }
        .header img { height: 70px; margin-bottom: 0; }
        h1 { display: none; }
        .sync-status { text-align: center; font-size: 0.7rem; color: #666; margin-top: 5px; }
        .sync-status.connected { color: #4ade80; }
        .sync-status.offline { color: #f59e0b; }
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; }
        .tab {
            flex: 1; padding: 12px 8px; background: transparent; border: 1px solid #333;
            color: #888; font-size: 0.9rem; cursor: pointer; border-radius: 6px; transition: all 0.2s;
        }
        .tab.active { background: #fff; color: #0a0a0a; border-color: #fff; font-weight: 600; }
        .panel { display: none; }
        .panel.active { display: block; }
        .section-title { color: #fff; margin: 24px 0 12px; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .input-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .input-row input, .input-row select {
            flex: 1; padding: 12px 14px; font-size: 1rem; border: 1px solid #333;
            border-radius: 6px; background: #111; color: #e8e8e8;
        }
        .input-row input:focus, .input-row select:focus { outline: none; border-color: #555; }
        .btn {
            padding: 12px 20px; font-size: 0.95rem; background: #fff; color: #0a0a0a;
            border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: opacity 0.2s;
        }
        .btn:hover { opacity: 0.9; }
        .btn.secondary { background: #222; color: #e8e8e8; border: 1px solid #333; }
        .btn.danger { background: #dc3545; color: white; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .card { background: #111; border: 1px solid #222; border-radius: 8px; padding: 14px; margin-bottom: 10px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .card-title { font-weight: 600; color: #fff; }
        .player-tag {
            display: inline-block; padding: 6px 12px; background: #222;
            border-radius: 4px; margin: 3px; font-size: 0.85rem; border: 1px solid #333;
        }
        .player-tag .remove { margin-left: 8px; color: #dc3545; cursor: pointer; }
        .scoreboard {
            display: flex; justify-content: space-around; align-items: center;
            background: #111; border: 1px solid #222; border-radius: 10px; padding: 20px; margin-bottom: 20px;
        }
        .team-score { text-align: center; flex: 1; padding: 12px; border-radius: 8px; transition: background 0.2s; }
        .team-score.has-disc { background: rgba(255,255,255,0.05); }
        .team-name { font-size: 0.9rem; color: #888; margin-bottom: 6px; }
        .score { font-size: 2.8rem; font-weight: 700; color: #fff; }
        .score-divider { font-size: 2rem; color: #333; padding: 0 15px; }
        .possession-indicator { font-size: 0.75rem; color: #4ade80; margin-top: 6px; min-height: 18px; }
        .chain-display {
            background: #111; border: 1px solid #222; border-radius: 8px; padding: 16px; margin-bottom: 20px; min-height: 70px;
        }
        .chain-label { font-size: 0.75rem; color: #666; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .chain-players { display: flex; flex-wrap: wrap; align-items: center; gap: 6px; }
        .chain-player {
            background: #fff; color: #0a0a0a; padding: 8px 14px;
            border-radius: 4px; font-weight: 600; font-size: 0.9rem;
        }
        .chain-arrow { color: #555; font-size: 1.1rem; }
        .chain-empty { color: #444; font-style: italic; }
        .team-section { margin-bottom: 20px; }
        .team-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .team-section-title { font-size: 0.9rem; color: #fff; font-weight: 600; }
        .player-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
        .player-btn {
            padding: 14px 8px; font-size: 0.85rem; background: #111; color: #e8e8e8;
            border: 1px solid #333; border-radius: 6px; cursor: pointer; text-align: center; transition: all 0.15s;
        }
        .player-btn:active { transform: scale(0.95); }
        .player-btn.in-chain { border-color: #fff; background: #222; }
        .player-btn.sub { background: #0a0a0a; color: #888; border-style: dashed; }
        .player-btn.offense { border-left: 3px solid #4ade80; }
        .player-btn.defense { border-left: 3px solid #f59e0b; }
        .action-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .action-btn {
            padding: 18px 10px; font-size: 0.95rem; border: none; border-radius: 8px;
            cursor: pointer; font-weight: 600; transition: all 0.15s;
        }
        .action-btn:active { transform: scale(0.97); }
        .action-btn.score-btn { background: #4ade80; color: #0a0a0a; grid-column: span 2; font-size: 1.1rem; }
        .action-btn.turnover { background: #dc3545; color: white; }
        .action-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .event-log { background: #111; border: 1px solid #222; border-radius: 8px; padding: 12px; max-height: 180px; overflow-y: auto; }
        .log-entry { padding: 8px 0; border-bottom: 1px solid #1a1a1a; font-size: 0.8rem; }
        .log-entry:last-child { border-bottom: none; }
        .log-score { color: #4ade80; font-weight: 600; }
        .log-turnover { color: #dc3545; }
        .log-defence { color: #f59e0b; }
        .log-assist { color: #888; }
        .stats-container { overflow-x: auto; margin-bottom: 15px; }
        .stats-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        .stats-table th, .stats-table td { padding: 10px 6px; text-align: center; border-bottom: 1px solid #222; }
        .stats-table th { background: #111; color: #888; font-weight: 600; text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.3px; position: sticky; top: 0; }
        .stats-table td { color: #ccc; }
        .stats-table td:first-child, .stats-table th:first-child { text-align: left; color: #fff; }
        .game-setup { text-align: center; padding: 30px 0; }
        .vs-display { display: flex; align-items: center; justify-content: center; gap: 15px; margin: 25px 0; }
        .vs-team { flex: 1; max-width: 140px; }
        .vs-team select { width: 100%; padding: 14px; font-size: 1rem; background: #111; color: #e8e8e8; border: 1px solid #333; border-radius: 6px; }
        .vs-text { font-size: 1.2rem; color: #444; font-weight: 600; }
        .first-possession { margin: 25px 0; }
        .first-possession label { display: block; margin-bottom: 12px; color: #666; font-size: 0.85rem; }
        .possession-btns { display: flex; gap: 10px; justify-content: center; }
        .possession-btn { padding: 14px 28px; font-size: 1rem; background: #111; color: #e8e8e8; border: 1px solid #333; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .possession-btn.selected { border-color: #fff; background: #222; }
        .actions-row { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
        .actions-row .btn { flex: 1; min-width: 100px; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); justify-content: center; align-items: center; z-index: 100; }
        .modal.show { display: flex; }
        .modal-content { background: #111; border: 1px solid #333; padding: 28px; border-radius: 12px; text-align: center; max-width: 90%; width: 320px; }
        .modal-content p { margin-bottom: 24px; color: #ccc; }
        .modal-buttons { display: flex; gap: 10px; justify-content: center; }
        .empty-state { text-align: center; color: #444; padding: 24px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="header">
        <img src="wukong-logo.png" alt="Wukong Ultimate">
        <div class="sync-status" id="sync-status">Connecting...</div>
    </div>
    <div class="tabs">
        <button class="tab active" onclick="showPanel('game')">Game</button>
        <button class="tab" onclick="showPanel('teams')">Teams</button>
        <button class="tab" onclick="showPanel('season')">Season</button>
    </div>

    <!-- Game Panel -->
    <div id="game-panel" class="panel active">
        <div id="game-setup" class="game-setup">
            <h3 class="section-title">Select Teams</h3>
            <div class="vs-display">
                <div class="vs-team"><select id="team-a-select"><option value="">Team A</option></select></div>
                <div class="vs-text">vs</div>
                <div class="vs-team"><select id="team-b-select"><option value="">Team B</option></select></div>
            </div>
            <div class="first-possession">
                <label>First Possession</label>
                <div class="possession-btns">
                    <button class="possession-btn" id="poss-a" onclick="selectFirstPossession('a')">--</button>
                    <button class="possession-btn" id="poss-b" onclick="selectFirstPossession('b')">--</button>
                </div>
            </div>
            <button class="btn" onclick="startGame()" id="start-game-btn" disabled>Start Game</button>
        </div>

        <div id="live-game" class="hidden">
            <div class="scoreboard">
                <div class="team-score" id="score-a">
                    <div class="team-name" id="team-a-name">Team A</div>
                    <div class="score" id="score-a-val">0</div>
                    <div class="possession-indicator" id="poss-ind-a"></div>
                </div>
                <div class="score-divider">-</div>
                <div class="team-score" id="score-b">
                    <div class="team-name" id="team-b-name">Team B</div>
                    <div class="score" id="score-b-val">0</div>
                    <div class="possession-indicator" id="poss-ind-b"></div>
                </div>
            </div>

            <div class="chain-display">
                <div class="chain-label">Current Possession</div>
                <div class="chain-players" id="chain-display"><span class="chain-empty">Tap a player to start</span></div>
            </div>

            <div class="action-buttons">
                <button class="action-btn score-btn" onclick="recordScore()" id="btn-score" disabled>SCORE (+500)</button>
                <button class="action-btn turnover" onclick="recordDrop()" id="btn-drop" disabled>Drop (-500)</button>
                <button class="action-btn turnover" onclick="recordThrowaway()" id="btn-ta" disabled>Throw Away (-250)</button>
            </div>

            <div class="team-section">
                <div class="team-section-header">
                    <span class="team-section-title" id="offense-label">Offense</span>
                    <span style="color: #4ade80; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.3px;">‚óè tap to pass</span>
                </div>
                <div class="player-grid" id="offense-players"></div>
            </div>

            <div class="team-section">
                <div class="team-section-header">
                    <span class="team-section-title" id="defense-label">Defense</span>
                    <span style="color: #f59e0b; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.3px;">‚óè tap for block</span>
                </div>
                <div class="player-grid" id="defense-players"></div>
            </div>

            <h3 class="section-title">Event Log</h3>
            <div class="event-log" id="event-log"><div class="empty-state">No events yet</div></div>

            <div class="actions-row">
                <button class="btn secondary" onclick="undoLast()">‚Ü© Undo</button>
                <button class="btn danger" onclick="confirmEndGame()">End Game</button>
            </div>

            <div id="game-end-downloads" class="hidden" style="margin-top:20px; padding:20px; background:#111; border:1px solid #222; border-radius:8px; text-align:center;">
                <p style="margin-bottom:16px; color:#4ade80; font-weight:600;">‚úì Game saved!</p>
                <div class="actions-row" style="margin:0;">
                    <button class="btn" onclick="downloadGameStatsCSV()">üì• Player Stats</button>
                    <button class="btn secondary" onclick="downloadGameEventsCSV()">üì• Event Log</button>
                </div>
                <button class="btn secondary" style="margin-top:10px; width:100%;" onclick="closeGameEnd()">Start New Game</button>
            </div>
        </div>
    </div>

    <!-- Teams Panel -->
    <div id="teams-panel" class="panel">
        <h3 class="section-title">Create Team</h3>
        <div class="input-row">
            <input type="text" id="new-team-name" placeholder="Team name" onkeypress="if(event.key==='Enter')addTeam()">
            <button class="btn" onclick="addTeam()">Add</button>
        </div>
        <div id="teams-list"></div>
        <div class="actions-row" style="margin-top: 30px;">
            <button class="btn danger" onclick="confirmResetAll()">Reset All Data</button>
        </div>
    </div>

    <!-- Season Panel -->
    <div id="season-panel" class="panel">
        <h3 class="section-title">Team Standings</h3>
        <div class="stats-container">
            <table class="stats-table" id="standings-table">
                <thead><tr><th>Team</th><th>W</th><th>L</th><th>PF</th><th>PA</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <h3 class="section-title">Season Player Stats</h3>
        <div class="stats-container">
            <table class="stats-table" id="season-stats-table">
                <thead><tr><th>Player</th><th>Team</th><th>GP</th><th>Sc</th><th>As</th><th>2nd</th><th>Def</th><th>Dr</th><th>TA</th><th>W</th><th>Pts</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <h3 class="section-title">Game History</h3>
        <div id="game-history-list"></div>
        <div class="actions-row">
            <button class="btn" onclick="downloadSeasonPlayerCSV()">üì• Players</button>
            <button class="btn secondary" onclick="downloadSeasonEventsCSV()">üì• Events</button>
        </div>
    </div>

    <!-- Role Selection Modal -->
    <div class="modal show" id="role-modal">
        <div class="modal-content">
            <img src="wukong-logo.png" alt="Wukong Ultimate" style="height:60px; margin-bottom:15px;">
            <p style="margin-bottom:20px; color:#fff;">Select your role</p>
            <div class="modal-buttons" style="flex-direction:column; gap:12px;">
                <button class="btn" onclick="selectRole('player')" style="width:100%;">Player</button>
                <button class="btn secondary" onclick="showAdminLogin()" style="width:100%;">Admin</button>
            </div>
            <div id="admin-login" class="hidden" style="margin-top:20px;">
                <input type="password" id="admin-password" placeholder="Enter admin password" style="width:100%; padding:12px; background:#111; border:1px solid #333; border-radius:6px; color:#e8e8e8; margin-bottom:12px;">
                <button class="btn" onclick="checkAdminPassword()" style="width:100%;">Enter</button>
                <p id="password-error" class="hidden" style="color:#dc3545; font-size:0.85rem; margin-top:10px;">Incorrect password</p>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirm-modal">
        <div class="modal-content">
            <p id="confirm-message">Are you sure?</p>
            <div class="modal-buttons">
                <button class="btn secondary" onclick="closeModal()">Cancel</button>
                <button class="btn danger" onclick="confirmAction()">Confirm</button>
            </div>
        </div>
    </div>

<script>
const POINTS = { score: 500, assist: 500, second_assist: 250, defence: 250, drop: -500, throwaway: -250, win: 500 };

// ============================================
// ADMIN PASSWORD - Change this to your password
// ============================================
const ADMIN_PASSWORD = "wukong2024";

// Check for player view mode from URL (legacy support)
const urlParams = new URLSearchParams(window.location.search);
const isPlayerViewURL = urlParams.get('view') === 'player';

// Role state
let isPlayerView = false;
let isLoggedIn = false;

// ============================================
// FIREBASE CONFIGURATION
// Replace these values with your Firebase project config
// ============================================
const firebaseConfig = {
    apiKey: "AIzaSyC1Wc00G0OQUkV3JbiF2EyJVITRxOLibCA",
    authDomain: "wkuc-21090.firebaseapp.com",
    databaseURL: "https://wkuc-21090-default-rtdb.firebaseio.com",
    projectId: "wkuc-21090",
    storageBucket: "wkuc-21090.firebasestorage.app",
    messagingSenderId: "29327349106",
    appId: "1:29327349106:web:90c9a54bbfaf58391839eb"
};

// Initialize Firebase
let db = null;
let useFirebase = false;

try {
    if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        useFirebase = true;
    }
} catch (e) {
    console.log('Firebase not configured, using localStorage');
}

// Data
let teams = {};
let seasonStats = {};
let seasonEvents = [];
let teamStandings = {};
let gameHistory = [];
let currentGame = null;
let pendingAction = null;
let firstPossession = null;

// Role selection
function selectRole(role) {
    if (role === 'player') {
        isPlayerView = true;
        isLoggedIn = true;
        document.getElementById('role-modal').classList.remove('show');
        initApp();
    }
}

function showAdminLogin() {
    document.getElementById('admin-login').classList.remove('hidden');
    document.getElementById('admin-password').focus();
}

function checkAdminPassword() {
    const input = document.getElementById('admin-password');
    if (input.value === ADMIN_PASSWORD) {
        isPlayerView = false;
        isLoggedIn = true;
        document.getElementById('role-modal').classList.remove('show');
        initApp();
    } else {
        document.getElementById('password-error').classList.remove('hidden');
        input.value = '';
        input.focus();
    }
}

// Allow Enter key to submit password
document.addEventListener('DOMContentLoaded', () => {
    const pwInput = document.getElementById('admin-password');
    if (pwInput) {
        pwInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') checkAdminPassword();
        });
    }
    
    // Auto-login if URL param is set
    if (isPlayerViewURL) {
        selectRole('player');
    }
});

// Sync status
function updateSyncStatus(status, isConnected) {
    const el = document.getElementById('sync-status');
    el.textContent = status;
    el.className = 'sync-status ' + (isConnected ? 'connected' : 'offline');
}

// Firebase data sync
function initFirebase() {
    if (!useFirebase) {
        updateSyncStatus('Local mode', false);
        loadFromLocalStorage();
        return;
    }

    // Listen for connection state
    db.ref('.info/connected').on('value', (snap) => {
        if (snap.val() === true) {
            updateSyncStatus('‚óè Synced', true);
        } else {
            updateSyncStatus('Offline', false);
        }
    });

    // Listen for data changes
    db.ref('teams').on('value', (snap) => {
        teams = snap.val() || {};
        renderTeams();
        renderTeamSelects();
    });

    db.ref('seasonStats').on('value', (snap) => {
        seasonStats = snap.val() || {};
        renderSeasonStats();
    });

    db.ref('teamStandings').on('value', (snap) => {
        teamStandings = snap.val() || {};
        renderSeasonStats();
    });

    db.ref('gameHistory').on('value', (snap) => {
        gameHistory = snap.val() || [];
        renderSeasonStats();
    });

    db.ref('seasonEvents').on('value', (snap) => {
        seasonEvents = snap.val() || [];
    });
}

function loadFromLocalStorage() {
    teams = JSON.parse(localStorage.getItem('uf_teams') || '{}');
    seasonStats = JSON.parse(localStorage.getItem('uf_season_stats') || '{}');
    seasonEvents = JSON.parse(localStorage.getItem('uf_season_events') || '[]');
    teamStandings = JSON.parse(localStorage.getItem('uf_standings') || '{}');
    gameHistory = JSON.parse(localStorage.getItem('uf_game_history') || '[]');
}

function saveTeams() {
    if (useFirebase) {
        db.ref('teams').set(teams);
    } else {
        localStorage.setItem('uf_teams', JSON.stringify(teams));
    }
}

function saveSeasonData() {
    if (useFirebase) {
        db.ref('seasonStats').set(seasonStats);
        db.ref('teamStandings').set(teamStandings);
        db.ref('gameHistory').set(gameHistory);
        db.ref('seasonEvents').set(seasonEvents);
    } else {
        localStorage.setItem('uf_season_stats', JSON.stringify(seasonStats));
        localStorage.setItem('uf_standings', JSON.stringify(teamStandings));
        localStorage.setItem('uf_game_history', JSON.stringify(gameHistory));
        localStorage.setItem('uf_season_events', JSON.stringify(seasonEvents));
    }
}

function clearAllData() {
    teams = {}; seasonStats = {}; seasonEvents = []; teamStandings = {}; gameHistory = [];
    if (useFirebase) {
        db.ref('teams').set(null);
        db.ref('seasonStats').set(null);
        db.ref('teamStandings').set(null);
        db.ref('gameHistory').set(null);
        db.ref('seasonEvents').set(null);
    } else {
        localStorage.removeItem('uf_teams');
        localStorage.removeItem('uf_season_stats');
        localStorage.removeItem('uf_season_events');
        localStorage.removeItem('uf_standings');
        localStorage.removeItem('uf_game_history');
    }
}

function initApp() {
    if (isPlayerView) {
        // Hide Game and Teams tabs, show only Season
        document.querySelectorAll('.tab').forEach(t => t.style.display = 'none');
        document.getElementById('game-panel').classList.remove('active');
        document.getElementById('season-panel').classList.add('active');
        // Hide action buttons in player view
        document.querySelectorAll('#season-panel .actions-row').forEach(el => el.style.display = 'none');
        // Hide Teams panel reset button
        document.querySelector('#teams-panel .btn.danger')?.parentElement?.remove();
    }
    
    if (useFirebase) {
        initFirebase();
    } else {
        loadFromLocalStorage();
        updateSyncStatus('Local mode', false);
        renderTeams();
        renderTeamSelects();
        renderSeasonStats();
    }
}

// Legacy init function - now handled by role selection
function init() {
    // Wait for role selection
}

function showPanel(panel) {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById(panel + '-panel').classList.add('active');
    event.target.classList.add('active');
    if (panel === 'season') renderSeasonStats();
    if (panel === 'game') renderTeamSelects();
}

// Teams
function addTeam() {
    const input = document.getElementById('new-team-name');
    const name = input.value.trim();
    if (name && !teams[name]) {
        teams[name] = [];
        saveTeams();
        renderTeams();
        renderTeamSelects();
        input.value = '';
    }
}

function deleteTeam(name) {
    showModal('Delete team "' + name + '" and all its players?', () => {
        delete teams[name];
        saveTeams();
        renderTeams();
        renderTeamSelects();
    });
}

function addPlayerToTeam(teamName) {
    const input = document.querySelector(`[data-team="${teamName}"]`);
    const playerName = input.value.trim();
    if (playerName && !teams[teamName].includes(playerName)) {
        teams[teamName].push(playerName);
        saveTeams();
        renderTeams();
        input.value = '';
    }
}

function removePlayerFromTeam(teamName, playerName) {
    showModal('Remove "' + playerName + '" from ' + teamName + '?', () => {
        teams[teamName] = teams[teamName].filter(p => p !== playerName);
        saveTeams();
        renderTeams();
    });
}

function renderTeams() {
    const container = document.getElementById('teams-list');
    const teamNames = Object.keys(teams);
    if (teamNames.length === 0) {
        container.innerHTML = '<div class="empty-state">No teams yet. Create one above.</div>';
        return;
    }
    container.innerHTML = teamNames.map(name => `
        <div class="card">
            <div class="card-header">
                <span class="card-title">${escHtml(name)}</span>
                <button class="btn danger" style="padding:6px 12px;font-size:0.8rem;" onclick="deleteTeam('${escJs(name)}')">Delete</button>
            </div>
            <div class="input-row" style="margin-bottom:10px;">
                <input type="text" data-team="${escHtml(name)}" placeholder="Add player" onkeypress="if(event.key==='Enter')addPlayerToTeam('${escJs(name)}')">
                <button class="btn" style="padding:8px 15px;" onclick="addPlayerToTeam('${escJs(name)}')">Add</button>
            </div>
            <div>${teams[name].length === 0 ? '<span style="color:#666;font-size:0.85rem;">No players</span>' : 
                teams[name].map(p => `<span class="player-tag">${escHtml(p)}<span class="remove" onclick="removePlayerFromTeam('${escJs(name)}','${escJs(p)}')">&times;</span></span>`).join('')}
            </div>
        </div>
    `).join('');
}

function escHtml(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escJs(s) { return s.replace(/\\/g,'\\\\').replace(/'/g,"\\'"); }

// Game Setup
function renderTeamSelects() {
    const teamNames = Object.keys(teams);
    const opts = '<option value="">Select team</option>' + teamNames.map(n => `<option value="${escHtml(n)}">${escHtml(n)}</option>`).join('');
    document.getElementById('team-a-select').innerHTML = opts;
    document.getElementById('team-b-select').innerHTML = opts;
    document.getElementById('team-a-select').onchange = updateGameSetup;
    document.getElementById('team-b-select').onchange = updateGameSetup;
    document.getElementById('poss-a').textContent = '--';
    document.getElementById('poss-b').textContent = '--';
    firstPossession = null;
    updateGameSetup();
}

function updateGameSetup() {
    const a = document.getElementById('team-a-select').value;
    const b = document.getElementById('team-b-select').value;
    document.getElementById('poss-a').textContent = a || '--';
    document.getElementById('poss-b').textContent = b || '--';
    document.getElementById('start-game-btn').disabled = !a || !b || a === b || !firstPossession;
}

function selectFirstPossession(team) {
    firstPossession = team;
    document.getElementById('poss-a').classList.toggle('selected', team === 'a');
    document.getElementById('poss-b').classList.toggle('selected', team === 'b');
    updateGameSetup();
}

function startGame() {
    const teamAName = document.getElementById('team-a-select').value;
    const teamBName = document.getElementById('team-b-select').value;
    currentGame = {
        teamA: { name: teamAName, players: [...teams[teamAName]], score: 0 },
        teamB: { name: teamBName, players: [...teams[teamBName]], score: 0 },
        possession: firstPossession,
        chain: [],
        events: [],
        stats: {},
        gameId: Date.now()
    };
    document.getElementById('game-setup').classList.add('hidden');
    document.getElementById('live-game').classList.remove('hidden');
    document.getElementById('team-a-name').textContent = teamAName;
    document.getElementById('team-b-name').textContent = teamBName;
    renderGameState();
}

function renderGameState() {
    if (!currentGame) return;
    document.getElementById('score-a-val').textContent = currentGame.teamA.score;
    document.getElementById('score-b-val').textContent = currentGame.teamB.score;
    const possA = currentGame.possession === 'a';
    document.getElementById('score-a').classList.toggle('has-disc', possA);
    document.getElementById('score-b').classList.toggle('has-disc', !possA);
    document.getElementById('poss-ind-a').textContent = possA ? '‚óè Offense' : '';
    document.getElementById('poss-ind-b').textContent = !possA ? '‚óè Offense' : '';
    const offTeam = possA ? currentGame.teamA : currentGame.teamB;
    const defTeam = possA ? currentGame.teamB : currentGame.teamA;
    document.getElementById('offense-label').textContent = offTeam.name + ' (Offense)';
    document.getElementById('defense-label').textContent = defTeam.name + ' (Defense)';
    const chainDiv = document.getElementById('chain-display');
    if (currentGame.chain.length === 0) {
        chainDiv.innerHTML = '<span class="chain-empty">Tap a player to start possession</span>';
    } else {
        chainDiv.innerHTML = currentGame.chain.map((p, i) => 
            `<span class="chain-player">${escHtml(p)}</span>${i < currentGame.chain.length - 1 ? '<span class="chain-arrow">‚Üí</span>' : ''}`
        ).join('');
    }
    renderPlayerButtons('offense-players', offTeam.players, true);
    renderPlayerButtons('defense-players', defTeam.players, false);
    const hasChain = currentGame.chain.length > 0;
    document.getElementById('btn-score').disabled = !hasChain;
    document.getElementById('btn-drop').disabled = !hasChain;
    document.getElementById('btn-ta').disabled = !hasChain;
    renderEventLog();
}

function renderPlayerButtons(containerId, players, isOffense) {
    const container = document.getElementById(containerId);
    const type = isOffense ? 'offense' : 'defense';
    let html = players.map(p => {
        const inChain = currentGame.chain.includes(p);
        return `<button class="player-btn ${type} ${inChain ? 'in-chain' : ''}" onclick="${isOffense ? `addToChain('${escJs(p)}')` : `recordDefence('${escJs(p)}')`}">${escHtml(p)}</button>`;
    }).join('');
    html += `<button class="player-btn sub ${type}" onclick="${isOffense ? "addToChain('Sub')" : "recordDefence('Sub')"}">Sub</button>`;
    container.innerHTML = html;
}

function getOffenseTeam() { return currentGame.possession === 'a' ? currentGame.teamA : currentGame.teamB; }
function getDefenseTeam() { return currentGame.possession === 'a' ? currentGame.teamB : currentGame.teamA; }

function addToChain(player) {
    currentGame.chain.push(player);
    logEvent('pass', player, getOffenseTeam().name);
    renderGameState();
}

function recordScore() {
    if (currentGame.chain.length === 0) return;
    const team = getOffenseTeam();
    const scorer = currentGame.chain[currentGame.chain.length - 1];
    addStat(scorer, team.name, 'score');
    logEvent('score', scorer, team.name);
    if (currentGame.chain.length >= 2) {
        const assister = currentGame.chain[currentGame.chain.length - 2];
        addStat(assister, team.name, 'assist');
        logEvent('assist', assister, team.name);
    }
    if (currentGame.chain.length >= 3) {
        const second = currentGame.chain[currentGame.chain.length - 3];
        addStat(second, team.name, 'second_assist');
        logEvent('second_assist', second, team.name);
    }
    if (currentGame.possession === 'a') currentGame.teamA.score++; else currentGame.teamB.score++;
    currentGame.possession = currentGame.possession === 'a' ? 'b' : 'a';
    currentGame.chain = [];
    renderGameState();
}

function recordDrop() {
    if (currentGame.chain.length === 0) return;
    const team = getOffenseTeam();
    const player = currentGame.chain[currentGame.chain.length - 1];
    addStat(player, team.name, 'drop');
    logEvent('drop', player, team.name);
    currentGame.possession = currentGame.possession === 'a' ? 'b' : 'a';
    currentGame.chain = [];
    renderGameState();
}

function recordThrowaway() {
    if (currentGame.chain.length === 0) return;
    const team = getOffenseTeam();
    const player = currentGame.chain[currentGame.chain.length - 1];
    addStat(player, team.name, 'throwaway');
    logEvent('throwaway', player, team.name);
    currentGame.possession = currentGame.possession === 'a' ? 'b' : 'a';
    currentGame.chain = [];
    renderGameState();
}

function recordDefence(player) {
    if (currentGame.chain.length === 0) {
        alert('Wait for offense to touch the disc first');
        return;
    }
    const team = getDefenseTeam();
    addStat(player, team.name, 'defence');
    logEvent('defence', player, team.name);
    currentGame.possession = currentGame.possession === 'a' ? 'b' : 'a';
    currentGame.chain = [];
    renderGameState();
}

function addStat(player, team, stat) {
    const key = `${player}|${team}`;
    if (!currentGame.stats[key]) {
        currentGame.stats[key] = { player, team, score: 0, assist: 0, second_assist: 0, defence: 0, drop: 0, throwaway: 0 };
    }
    currentGame.stats[key][stat]++;
}

function logEvent(type, player, team) {
    currentGame.events.push({ ts: new Date().toISOString(), type, player, team, chain: [...currentGame.chain], poss: currentGame.possession });
}

function renderEventLog() {
    const container = document.getElementById('event-log');
    const evts = currentGame.events.slice().reverse().slice(0, 30);
    if (evts.length === 0) { container.innerHTML = '<div class="empty-state">No events yet</div>'; return; }
    const labels = { pass: 'Pass', score: 'SCORE', assist: 'Assist', second_assist: '2nd Ast', defence: 'DEFENCE', drop: 'DROP', throwaway: 'THROW AWAY' };
    const cls = { pass: '', score: 'log-score', assist: 'log-assist', second_assist: 'log-assist', defence: 'log-defence', drop: 'log-turnover', throwaway: 'log-turnover' };
    container.innerHTML = evts.map(e => `<div class="log-entry"><span class="${cls[e.type]}">${labels[e.type]}</span> - ${escHtml(e.player)} (${escHtml(e.team)})</div>`).join('');
}

function undoLast() {
    if (!currentGame || currentGame.events.length === 0) return;
    const last = currentGame.events.pop();
    if (last.type !== 'pass') {
        const key = `${last.player}|${last.team}`;
        if (currentGame.stats[key]) currentGame.stats[key][last.type]--;
    }
    if (last.type === 'score') {
        if (last.team === currentGame.teamA.name) currentGame.teamA.score--; else currentGame.teamB.score--;
        currentGame.possession = last.poss;
        // Remove assist and 2nd assist
        while (currentGame.events.length > 0) {
            const prev = currentGame.events[currentGame.events.length - 1];
            if (prev.type === 'assist' || prev.type === 'second_assist') {
                const k = `${prev.player}|${prev.team}`;
                if (currentGame.stats[k]) currentGame.stats[k][prev.type]--;
                currentGame.events.pop();
            } else break;
        }
        // Restore chain
        const lastPass = currentGame.events.length > 0 ? currentGame.events[currentGame.events.length - 1] : null;
        currentGame.chain = lastPass && lastPass.chain ? [...lastPass.chain] : [];
    }
    if (last.type === 'drop' || last.type === 'throwaway' || last.type === 'defence') {
        currentGame.possession = last.poss;
        const lastPass = currentGame.events.length > 0 ? currentGame.events[currentGame.events.length - 1] : null;
        currentGame.chain = lastPass && lastPass.chain ? [...lastPass.chain] : [];
    }
    if (last.type === 'pass') {
        currentGame.chain = currentGame.chain.slice(0, -1);
    }
    renderGameState();
}

function confirmEndGame() { showModal('End game and save stats?', endGame); }

function endGame() {
    const winner = currentGame.teamA.score > currentGame.teamB.score ? currentGame.teamA :
                   currentGame.teamB.score > currentGame.teamA.score ? currentGame.teamB : null;
    // Mark all rostered players as having played
    [currentGame.teamA, currentGame.teamB].forEach(team => {
        team.players.forEach(p => {
            const key = `${p}|${team.name}`;
            if (!currentGame.stats[key]) {
                currentGame.stats[key] = { player: p, team: team.name, score: 0, assist: 0, second_assist: 0, defence: 0, drop: 0, throwaway: 0 };
            }
        });
    });
    // Save game to history
    gameHistory.push({
        id: currentGame.gameId,
        date: new Date().toISOString(),
        teamA: { name: currentGame.teamA.name, score: currentGame.teamA.score },
        teamB: { name: currentGame.teamB.name, score: currentGame.teamB.score },
        winner: winner ? winner.name : null,
        stats: currentGame.stats,
        events: currentGame.events
    });
    // Update standings
    updateStandings(currentGame.teamA.name, currentGame.teamA.score, currentGame.teamB.score);
    updateStandings(currentGame.teamB.name, currentGame.teamB.score, currentGame.teamA.score);
    // Merge to season
    for (const key in currentGame.stats) {
        const gs = currentGame.stats[key];
        if (!seasonStats[key]) {
            seasonStats[key] = { player: gs.player, team: gs.team, games: 0, wins: 0, score: 0, assist: 0, second_assist: 0, defence: 0, drop: 0, throwaway: 0 };
        }
        const ss = seasonStats[key];
        ss.games++;
        ss.score += gs.score;
        ss.assist += gs.assist;
        ss.second_assist += gs.second_assist;
        ss.defence += gs.defence;
        ss.drop += gs.drop;
        ss.throwaway += gs.throwaway;
        if (winner && gs.team === winner.name) ss.wins++;
    }
    seasonEvents = seasonEvents.concat(currentGame.events);
    // Save to Firebase or localStorage
    saveSeasonData();
    // Store game data for optional download
    lastGameData = { stats: currentGame.stats, events: currentGame.events };
    // Show download options instead of auto-downloading
    document.getElementById('game-end-downloads').classList.remove('hidden');
    // Hide game controls
    document.querySelectorAll('.action-buttons, .team-section, .chain-display').forEach(el => el.classList.add('hidden'));
}

let lastGameData = null;

function downloadGameStatsCSV() {
    if (!lastGameData) return;
    const date = new Date().toISOString().slice(0, 10);
    const h = ['Player', 'Team', 'Score', 'Assist', '2nd Assist', 'Defence', 'Drop', 'Throw Away', 'Points'];
    const r = Object.values(lastGameData.stats).map(s => [s.player, s.team, s.score, s.assist, s.second_assist, s.defence, s.drop, s.throwaway, calcPoints(s, false)]);
    downloadCSV(`game-stats-${date}.csv`, h, r);
}

function downloadGameEventsCSV() {
    if (!lastGameData) return;
    const date = new Date().toISOString().slice(0, 10);
    const h = ['Timestamp', 'Team', 'Player', 'Event', 'Chain'];
    const r = lastGameData.events.map(e => [e.ts, e.team, e.player, e.type, (e.chain || []).join(' ‚Üí ')]);
    downloadCSV(`game-events-${date}.csv`, h, r);
}

function closeGameEnd() {
    lastGameData = null;
    document.getElementById('game-end-downloads').classList.add('hidden');
    resetGameUI();
}

function updateStandings(team, pf, pa) {
    if (!teamStandings[team]) teamStandings[team] = { wins: 0, losses: 0, pf: 0, pa: 0 };
    teamStandings[team].pf += pf;
    teamStandings[team].pa += pa;
    if (pf > pa) teamStandings[team].wins++; else if (pa > pf) teamStandings[team].losses++;
}

function calcPoints(s, includeWins = true) {
    return s.score * POINTS.score + s.assist * POINTS.assist + s.second_assist * POINTS.second_assist +
           s.defence * POINTS.defence + s.drop * POINTS.drop + s.throwaway * POINTS.throwaway +
           (includeWins ? (s.wins || 0) * POINTS.win : 0);
}

function resetGameUI() {
    currentGame = null;
    firstPossession = null;
    document.getElementById('game-setup').classList.remove('hidden');
    document.getElementById('live-game').classList.add('hidden');
    document.getElementById('poss-a').classList.remove('selected');
    document.getElementById('poss-b').classList.remove('selected');
    // Restore hidden elements for next game
    document.querySelectorAll('.action-buttons, .team-section, .chain-display').forEach(el => el.classList.remove('hidden'));
    document.getElementById('game-end-downloads').classList.add('hidden');
    renderTeamSelects();
}

// Season
function renderSeasonStats() {
    // Standings
    const stBody = document.querySelector('#standings-table tbody');
    const st = Object.entries(teamStandings).sort((a, b) => b[1].wins - a[1].wins || (b[1].pf - b[1].pa) - (a[1].pf - a[1].pa));
    stBody.innerHTML = st.length === 0 ? '<tr><td colspan="5" class="empty-state">No games yet</td></tr>' :
        st.map(([n, s]) => `<tr><td>${escHtml(n)}</td><td>${s.wins}</td><td>${s.losses}</td><td>${s.pf}</td><td>${s.pa}</td></tr>`).join('');
    // Players
    const pBody = document.querySelector('#season-stats-table tbody');
    const players = Object.values(seasonStats).sort((a, b) => calcPoints(b) - calcPoints(a));
    pBody.innerHTML = players.length === 0 ? '<tr><td colspan="11" class="empty-state">No stats yet</td></tr>' :
        players.map(s => `<tr><td>${escHtml(s.player)}</td><td>${escHtml(s.team)}</td><td>${s.games}</td><td>${s.score}</td><td>${s.assist}</td><td>${s.second_assist}</td><td>${s.defence}</td><td>${s.drop}</td><td>${s.throwaway}</td><td>${s.wins}</td><td><b>${calcPoints(s)}</b></td></tr>`).join('');
    // Game history
    renderGameHistory();
}

function renderGameHistory() {
    const container = document.getElementById('game-history-list');
    if (gameHistory.length === 0) {
        container.innerHTML = '<div class="empty-state">No games played yet</div>';
        return;
    }
    container.innerHTML = gameHistory.slice().reverse().map((game, idx) => {
        const gameIdx = gameHistory.length - 1 - idx;
        const date = new Date(game.date).toLocaleDateString();
        const winnerTag = game.winner ? ` <span style="color:#4ade80;">‚úì ${escHtml(game.winner)}</span>` : ' <span style="color:#444;">Tie</span>';
        return `
        <div class="card" style="margin-bottom:10px;">
            <div class="card-header" onclick="toggleGameDetail(${gameIdx})" style="cursor:pointer;">
                <span><b>${escHtml(game.teamA.name)} ${game.teamA.score} - ${game.teamB.score} ${escHtml(game.teamB.name)}</b>${winnerTag}</span>
                <span style="color:#666;font-size:0.8rem;">${date}</span>
            </div>
            <div id="game-detail-${gameIdx}" class="hidden">
                <div class="stats-container" style="margin-top:10px;">
                    <table class="stats-table">
                        <thead><tr><th>Player</th><th>Team</th><th>Sc</th><th>As</th><th>2nd</th><th>Def</th><th>Dr</th><th>TA</th><th>Pts</th></tr></thead>
                        <tbody>
                            ${Object.values(game.stats).sort((a,b) => calcPoints(b,false) - calcPoints(a,false)).map(s => 
                                `<tr><td>${escHtml(s.player)}</td><td>${escHtml(s.team)}</td><td>${s.score}</td><td>${s.assist}</td><td>${s.second_assist}</td><td>${s.defence}</td><td>${s.drop}</td><td>${s.throwaway}</td><td><b>${calcPoints(s,false)}</b></td></tr>`
                            ).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="actions-row" style="margin-top:10px;">
                    <button class="btn" style="padding:8px 12px;font-size:0.8rem;" onclick="downloadHistoryGameCSV(${gameIdx})">üì• Stats</button>
                    <button class="btn secondary" style="padding:8px 12px;font-size:0.8rem;" onclick="downloadHistoryEventsCSV(${gameIdx})">üì• Events</button>
                </div>
            </div>
        </div>`;
    }).join('');
}

function toggleGameDetail(idx) {
    const el = document.getElementById('game-detail-' + idx);
    el.classList.toggle('hidden');
}

function downloadHistoryGameCSV(idx) {
    const game = gameHistory[idx];
    const date = new Date(game.date).toISOString().slice(0, 10);
    const h = ['Player', 'Team', 'Score', 'Assist', '2nd Assist', 'Defence', 'Drop', 'Throw Away', 'Points'];
    const r = Object.values(game.stats).map(s => [s.player, s.team, s.score, s.assist, s.second_assist, s.defence, s.drop, s.throwaway, calcPoints(s, false)]);
    downloadCSV(`game-${idx + 1}-stats-${date}.csv`, h, r);
}

function downloadHistoryEventsCSV(idx) {
    const game = gameHistory[idx];
    const date = new Date(game.date).toISOString().slice(0, 10);
    const h = ['Timestamp', 'Team', 'Player', 'Event', 'Chain'];
    const r = game.events.map(e => [e.ts, e.team, e.player, e.type, (e.chain || []).join(' ‚Üí ')]);
    downloadCSV(`game-${idx + 1}-events-${date}.csv`, h, r);
}

function downloadSeasonPlayerCSV() {
    const h = ['Player', 'Team', 'Games', 'Score', 'Assist', '2nd Assist', 'Defence', 'Drop', 'Throw Away', 'Wins', 'Points'];
    const r = Object.values(seasonStats).map(s => [s.player, s.team, s.games, s.score, s.assist, s.second_assist, s.defence, s.drop, s.throwaway, s.wins, calcPoints(s)]);
    downloadCSV('season-player-stats.csv', h, r);
}

function downloadSeasonEventsCSV() {
    const h = ['Timestamp', 'Team', 'Player', 'Event', 'Chain'];
    const r = seasonEvents.map(e => [e.ts, e.team, e.player, e.type, (e.chain || []).join(' ‚Üí ')]);
    downloadCSV('season-events.csv', h, r);
}

function downloadCSV(filename, headers, rows) {
    const csv = [headers.join(','), ...rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(','))].join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
}

// Modal
function showModal(msg, action) {
    document.getElementById('confirm-message').textContent = msg;
    document.getElementById('confirm-modal').classList.add('show');
    pendingAction = action;
}
function closeModal() { document.getElementById('confirm-modal').classList.remove('show'); pendingAction = null; }
function confirmAction() { if (pendingAction) pendingAction(); closeModal(); }

function confirmResetAll() {
    showModal('Delete ALL teams and season data?', () => {
        clearAllData();
        renderTeams(); renderTeamSelects(); renderSeasonStats();
    });
}

init();
</script>
</body>
</html>
